import pigpio
import time
from datetime import datetime

# Configuration
TRIGGER_PIN = 17  # GPIO pin to monitor

pi = pigpio.pi()
if not pi.connected:
    print("Failed to connect to pigpio daemon")
    exit(1)

# Setup GPIO
pi.set_mode(TRIGGER_PIN, pigpio.INPUT)
pi.set_pull_up_down(TRIGGER_PIN, pigpio.PUD_DOWN)  # Hardware stabilization

# Add glitch filter to ignore noise (100ms = 100000Âµs)
pi.set_glitch_filter(TRIGGER_PIN, 100000)

def trigger_callback(gpio, level, tick):
    if level == 1:
        timestamp = datetime.now().strftime("%H:%M:%S.%f")[:-3]
        print(f"[{timestamp}] HIGH pulse detected on GPIO{gpio}")

# Register callback for rising edge detection
pi.callback(TRIGGER_PIN, pigpio.RISING_EDGE, trigger_callback)

try:
    print("Pulse detector running...")
    print(f"Monitoring GPIO{TRIGGER_PIN}")
    print("Press CTRL+C to exit")
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\nStopping detector...")
finally:
    pi.stop()
